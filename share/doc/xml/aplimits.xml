 <?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE cxchelptopics SYSTEM "CXCHelp.dtd">
<cxchelptopics>
  <ENTRY context="tools" key="aprates" refkeywords="poisson net count rate flux
  background psf fraction average exposure upper limit" 
  seealsogroups="stattools">
    <SYNOPSIS>
      Compute upper limits for the detection of a source, using data
      obtained from background apertures in event lists, images,
      and exposure maps.
    </SYNOPSIS>
    <DESC>
      <PARA>
    The aplimits tool estimates the upper limit for a detection. This is a
    property of the dection process and depends on the vales chosen for
    two error conditions called the type I and type II error. The type I
    error describes the maximum probability of a false detection, i.e. that
    a background fluctuation alone exceeds the calculated upper limit. The
    type II error describes the probability that a source with a flux of
    exactly the upper limit will be missed, because Poisson fluctuation of
    background and source counts lead to an observed count rate that is
    below the detection limit. The value of the upper limit depends
    only on the background rate and the probabilities chosen for the type
    I and II errors, not on the observed number of counts in the source region.
    All input is obtained from the input parameter file; output is written
	to an output parameter file.
    </PARA>
    <PARA>
    It is possible to find combinations of parameters that numerically result
    in a negative upper limit. Since this does not make sense physically,
    0 is reported as the upper limit in these cases.
    </PARA>
    <PARA>
    If the background rate is not known exactly, it can be estimated from the
    number of counts in a large source-free background region. In this case,
    the true background rate is not known, and a Baysian computation needs to
    marginalize over the possible background rates. To perform this
    computation, one needs to set a prior on the background count rate.
    This tool uses an uninformative prior expressed as a Gamma distribution
    which represents an prior knowlegde of 0 counts in 0 area.
    This uninformantive prior is an "improper" prior, which means that it cannot
    be normalized. However, the gamma distribution is the conjugate prior for
    this process and thus the posterior for the background rate can be
    calculated analytically given the number of observed background counts.
    The functional form for the posterior is the same as for aprates.
    </PARA>
    <PARA>
	This tool is based on 
    <HREF link="https://ui.adsabs.harvard.edu/abs/2010ApJ...719..900K">On computing upper limits to source intensities</HREF>, Kashyap et al. 2010, ApJ, 719, 900.
	</PARA>
 
	<PARA title="User inputs">
    This tool can either assume perfect knowledge of the background; in this
    case the parameter bkg_rate must be set. Alternatively, the user can
    set the number of counts m in the background region, and, unless source
    and background region have the same area and exposure time, also set the
    the geometric areas (A_s, A_b) and respective exposure times (T_s, T_b).
    If both bkg_rate and m are given, the tool assumes that the background
    rate is known and ignores the setting for m.

   <PARA title="Things to Watch Out For:">
   </PARA>

   <PARA title="1.) Extracting Aperture Quantities">
     A number of different CIAO tools can be used to determine the area and
     number of events in apertures. These tools may yield slightly different
     results, depending on whether one starts with an event list or
     image. Results from event lists are more accurate, since event
     locations are typically known to finer resolution that a pixel size, and
     areas can be determined analytically for simple apertures. For
     images, aperture counts and areas are determined from those pixels whose centers
     fall within the aperture. We recommend the use of dmextract if an event
     list is available.
   </PARA>
   <PARA>
     Unfortunately, determination of effective exposure and psf fractions in
     apertures will almost always require the use of exposure map and psf
     images, leading to possible inaccuracies in the determination of these
     quantities. For apertures containing many image pixels, this is a
     negligible effect, because exposure maps typically vary smoothly, and
     thus inclusion or exclusion of particular exposure map pixels has little
     effect on the average in the aperture. Similarly, the psf fraction
     change due to inclusion or exclusion of a few pixels at the aperture edge
     is likely to be small.
   </PARA>
   <PARA>
     This will not be the case, however, if aperture sizes are small compared
     to image pixel sizes. In those cases, it is recommended that the user
     repixelate the psf and exposure map images to a finer scale.
   </PARA>
</DESC>

   <QEXAMPLELIST>
     <QEXAMPLE>
     <DESC>
    <PARA>
    In this example, we know the background rate and calculate the upper limit on the flux.
    We want to be the probability for a background fluctuation to appear as a source to
    be less than 5%, and we want the probability to miss a real source with a flux
    comparable to the upper limit to be below 50%. The expected background in the source
    aperture is 1.23 counts (bkg_rate is given per unit area and unit exposure time, and
    exposure time and area of the source aperture also default to 1, so for a rate or 1.23
    we expect 1.23 source counts).
    </PARA></DESC>
       <SYNTAX>
<LINE>unix% aplimits typeIerror=.1 typeIIerror=.5 bkg_rate=1.23</LINE>
<LINE>unix% pget aplimits_out.par upper_limit</LINE>
<LINE>2.44206</LINE>
<LINE>3</LINE>
       </SYNTAX>
       <DESC>
         <PARA>
            In this example, the upper limit for an undetected source is 2.44 counts per unit
            exposure time and area.
         </PARA>
       </DESC>
     </QEXAMPLE>

     <QEXAMPLE>
     <DESC>
    <PARA>
    If the background rate is not known exactly, the tool can marginalize over all 
    possible background rates given the information on a single backgound measurement.
    With 5 counts in the background aperture and a region that is about 4.065 times
    larger than the source aperture, one might naively expect a background count rate
    of 5/4.065=1.23. However, given Poisson statistics, the true background rate could
    be higher or lower and thus the resulting upper limit will differ slightly from
    the result in the previous example.
    </PARA></DESC>
       <SYNTAX>
<LINE>unix% aplimits typeIerror=.1 typeIIerror=.5 m=5 A_b=4.065</LINE>
<LINE>unix% pget aplimits_out.par upper_limit</LINE>
<LINE>2.2316</LINE>
       </SYNTAX>

     </QEXAMPLE>
    </QEXAMPLELIST>
 
    <ADESC title="About Contributed Software">
      <PARA>
	This script is not an official part of the CIAO release but is
	made available as "contributed" software via the
	<HREF link="https://cxc.harvard.edu/ciao/download/scripts/">CIAO scripts page</HREF>.
	Please see this page for installation instructions - such as how to
	ensure that the parameter file is available.
      </PARA>
    </ADESC>

   <BUGS>
	<PARA>
	For an up-to-date listing of known bugs, see the
        <HREF link="https://cxc.harvard.edu/ciao/bugs/aplimits.html">bugs page
        for this tool.</HREF>
      </PARA>
    </BUGS>
   <LASTMODIFIED>October 2022</LASTMODIFIED>
</ENTRY>
</cxchelptopics>
